---
title: "Global Spatial Autocorrelation with Point Process Data"
author: "Sri Ramesh"
date: "4/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# visualization
library(rgdal)
library(raster)
library(ggplot2)
library(spatstat)
library(plotrix)
library(fields)
library(leaflet)
library(maptools)
library(RColorBrewer)
library(lattice)
library(geoR)
library(plotrix) 

# spatial data management and point process analysis
library(sp)
library(tidyverse)
library(gtools)

# Moran's I and spatial dependencies
library(spdep) # Spatial Dependence: Weighting Schemes, Statistics and Models
library(ape) # Analyses of Phylogenetics and Evolution
library(pgirmess) # Data Analysis in Ecology

# point processes
library(spatstat)
library(splancs) # K-function
library(smacpod) # Spatial scanning statistic
library(car) # contains a function for logistic transformation (log odds ratio) to make more normal

```

## Ripley's K

In this document, I will focus on conducting Ripley's K analysis to detect global spatial autocorrleation in point process data. I will use Professor Hugh Sturrock's Nairobi case control data.

```{r, echo = T, warning=F, message=F}
# load data
nairobi_cases <- read.csv("cases_nairobi.csv")
nairobi_cases_spdf <- SpatialPointsDataFrame(coords = nairobi_cases[,c("lng", "lat")], 
                                             data = nairobi_cases[,c("X", "case")])

KEN_Adm0 <- raster::getData('GADM',country='KEN',level=0)

# convert case-control data to spdf
nairobi_cases <- nairobi_cases %>% mutate(case = as.integer(case))
nairobicases_spdf <- SpatialPointsDataFrame(coords = nairobi_cases %>% select(lng, lat),
                                            data = nairobi_cases %>% select(X, case))

# map
case_color_scheme <- colorNumeric(c("grey", "red"), nairobicases_spdf$case)

basemap <- leaflet() %>% addProviderTiles("CartoDB.Positron")
basemap %>%
  addCircleMarkers(data=nairobicases_spdf,
                   color = case_color_scheme(nairobicases_spdf$case),
                   radius=1)

```

* Ripley's K will summarize *spatial dependence* in point process data like this
* our case data = one point process
* our control data = another point process

```{r, echo = T, warning=F, message=F}
# subset cases and controls into separate objects
cases <- nairobicases_spdf[nairobi_cases$case %in% 1, ]
controls <- nairobicases_spdf[nairobi_cases$case %in% 2, ]

# generate k function for CASES
cases_ppp <- cases %>% as("ppp")
# note different border-corrected estimates ('iso', 'border' and 'trans')
K <- cases_ppp %>% Kest(correction=c("isotropic", "Ripley")) # uses the "spatstat" package

# Plot the estimate of K(r) for CASES using MC simuluation for the confidence interval/envelope
par(mfrow=c(1,1))
E <- cases_ppp %>% envelope(Kest, nsim=999)
E %>% plot(main="Monte Carlo simluation (nsim=999) of the K-function for Cases only",
           xlab="Distances (r)",
           ylab="K-function K(r)")

```

* the red dashed line represents what we expect the spatial pattern to be under the null hypothesis of the Ripley's K test (ie complete spatial randomness, also known as homogenous poisson process)
* the black line represents our observed spatial pattern for the **case** point process
* in this case, it looks like our cases point process is completely spatially random and follows a HPP distribution (perhaps this data is fabricated?)
* the Monte Carlo simulation is used primarily to calculate the confidence interval/envelope, where Khi is the upper bound and Klo is the lower bound. This is important because it is solely what allows us to conduct the hypothesis test, which ultimately is important because it gives us a sense of how common our observed spatial pattern is out of all the spatial patterns we are likely to see

```{r, echo = T, warning=F, message=F}
casecontrol_ppp <- ppp(nairobi_cases$lng, nairobi_cases$lat,
                       range(nairobi_cases$lng), range(nairobi_cases$lat),
                       marks = as.factor(nairobi_cases$case))

# Calculate the K-function for cases
KX <- casecontrol_ppp[casecontrol_ppp$marks %in% 1] %>% Kest(correction=c("isotropic", "Ripley"))
KX %>% plot(sqrt(iso/pi) ~ r, main="K function for cases")

# Calculate the K-function for controls
KY <- casecontrol_ppp[casecontrol_ppp$marks %in% 2] %>% Kest(correction=c("isotropic", "Ripley"))
KY %>% plot(sqrt(iso/pi) ~ r, main="K function for controls")

# Calulate the difference in the two functions
Kdiff <- eval.fv(KX - KY)
Kdiff %>% plot(legendpos="float", main="K function of cases - K function of controls")
```

* again, the red dashed line is what we would expect in the event of complete spatial randomness
* why is this graph sloping down?

```{r}
# “Smacpod” package includes a function to estimate the difference in K function and plot simulated CI. Also includes a function to the test the significance based on these simulations
kdest = casecontrol_ppp %>% kdest(case = 2, nsim=999, level=0.95, correction=c("isotropic", "Ripley"))  #"smacpod" package

# Note that the case = is position of the marks, not the value!  levels(CaseControlPPP$marks)
kdest %>% plot() # dark grey is min/max; light grey is confidence envelope (can change these with options)
kdest %>% kdplus.test() # Performs test of significance based on simulated confidence envelope and observed statistic
```

